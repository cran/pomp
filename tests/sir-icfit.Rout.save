
R version 2.13.1 (2011-07-08)
Copyright (C) 2011 The R Foundation for Statistical Computing
ISBN 3-900051-07-0
Platform: x86_64-unknown-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> library(pomp)
Loading required package: mvtnorm
Loading required package: subplex
Loading required package: deSolve
> 
> set.seed(343435488L)
> 
> pdf(file="sir-icfit.pdf")
> 
> data(euler.sir)
> po <- window(euler.sir,end=0.2)
> guess <- coef(po)
> ics <- c("S.0","I.0","R.0") 
> guess[ics[-3]] <- guess[ics[-3]]+c(0.2,-0.2)
> 
> plist <- list(
+               probe.marginal("reports",ref=obs(po),order=3,diff=1,transform=sqrt),
+               probe.acf("reports",lags=c(0,1,2,3,4,5),transform=sqrt),
+               median=probe.median("reports")
+               )
> 
> summary(pm.true <- probe(po,probes=plist,nsim=100,seed=1066L))
$coef
     gamma         mu       iota     nbasis     degree     period      beta1 
 3.2580965 -3.9120230 -4.6051702  3.0000000  3.0000000  1.0000000  7.0900768 
     beta2      beta3    beta.sd        pop        rho        S.0        I.0 
 7.4955419  6.3969297 -6.9077553 14.5574479 -0.5108256 -3.8319803 -6.9077553 
       R.0 
-0.0229275 

$nsim
[1] 100

$quantiles
       marg.1        marg.2        marg.3 acf.0.reports acf.1.reports 
         0.96          0.39          0.06          0.45          0.47 
acf.2.reports acf.3.reports acf.4.reports acf.5.reports        median 
         0.31          0.20          0.89          0.79          0.59 

$pvals
       marg.1        marg.2        marg.3 acf.0.reports acf.1.reports 
    0.0990099     0.7920792     0.1386139     0.9108911     0.9504950 
acf.2.reports acf.3.reports acf.4.reports acf.5.reports        median 
    0.6336634     0.4158416     0.2376238     0.4356436     0.8118812 

$synth.loglik
[1] -3.327182

> 
> summary(pm.guess <- probe(po,params=guess,probes=plist,nsim=100,seed=1066L))
$coef
     gamma         mu       iota     nbasis     degree     period      beta1 
 3.2580965 -3.9120230 -4.6051702  3.0000000  3.0000000  1.0000000  7.0900768 
     beta2      beta3    beta.sd        pop        rho        S.0        I.0 
 7.4955419  6.3969297 -6.9077553 14.5574479 -0.5108256 -3.6319803 -7.1077553 
       R.0 
-0.0229275 

$nsim
[1] 100

$quantiles
       marg.1        marg.2        marg.3 acf.0.reports acf.1.reports 
         0.91          0.28          0.07          0.00          0.00 
acf.2.reports acf.3.reports acf.4.reports acf.5.reports        median 
         0.00          0.00          1.00          1.00          0.00 

$pvals
       marg.1        marg.2        marg.3 acf.0.reports acf.1.reports 
   0.19801980    0.57425743    0.15841584    0.01980198    0.01980198 
acf.2.reports acf.3.reports acf.4.reports acf.5.reports        median 
   0.01980198    0.01980198    0.01980198    0.01980198    0.01980198 

$synth.loglik
[1] -63.04768

> 
> pm.fit <- probe.match(
+                       po,
+                       start=guess,
+                       probes=plist,
+                       est=ics[-1],
+                       method="Nelder-Mead",
+                       trace=3,
+                       reltol=1e-5,
+                       parscale=c(0.1,0.1),
+                       nsim=100,
+                       seed=1066L
+                      )
  Nelder-Mead direct search function minimizer
function value for initial parameters = 63.047679
  Scaled convergence tolerance is 0.000630477
Stepsize computed as 7.107755
BUILD              3 4929.990658 63.047679
HI-REDUCTION       5 601.469297 63.047679
HI-REDUCTION       7 496.928487 10.499482
HI-REDUCTION       9 71.488070 10.499482
HI-REDUCTION      11 63.047679 10.499482
LO-REDUCTION      13 42.035345 3.573073
HI-REDUCTION      15 14.564709 3.573073
HI-REDUCTION      17 10.499482 3.573073
HI-REDUCTION      19 7.478882 3.573073
REFLECTION        21 5.096958 2.628314
HI-REDUCTION      23 3.573073 2.628314
SHRINK            27 3.617480 2.109975
LO-REDUCTION      29 2.628314 2.109975
HI-REDUCTION      31 2.482146 2.109975
HI-REDUCTION      33 2.203390 1.540292
SHRINK            37 3.121442 1.540292
LO-REDUCTION      39 2.324264 1.540292
SHRINK            43 2.420458 1.540292
SHRINK            47 4.610749 1.540292
LO-REDUCTION      49 2.444944 1.540292
LO-REDUCTION      51 2.439068 1.540292
HI-REDUCTION      53 2.012399 1.540292
SHRINK            57 3.233547 1.540292
LO-REDUCTION      59 1.972827 1.540292
SHRINK            63 3.404917 1.540292
LO-REDUCTION      65 2.424849 1.540292
SHRINK            69 2.424849 1.540292
HI-REDUCTION      71 2.393003 1.540292
SHRINK            75 2.393003 1.540292
SHRINK            79 3.279083 1.540292
Exiting from Nelder Mead minimizer
    81 function evaluations used
> 
> summary(pm.fit)
$coef
     gamma         mu       iota     nbasis     degree     period      beta1 
 3.2580965 -3.9120230 -4.6051702  3.0000000  3.0000000  1.0000000  7.0900768 
     beta2      beta3    beta.sd        pop        rho        S.0        I.0 
 7.4955419  6.3969297 -6.9077553 14.5574479 -0.5108256 -3.6319803 -6.6916777 
       R.0 
 0.1777793 

$nsim
[1] 100

$quantiles
       marg.1        marg.2        marg.3 acf.0.reports acf.1.reports 
         0.89          0.42          0.09          0.52          0.46 
acf.2.reports acf.3.reports acf.4.reports acf.5.reports        median 
         0.35          0.23          0.91          0.75          0.43 

$pvals
       marg.1        marg.2        marg.3 acf.0.reports acf.1.reports 
    0.2376238     0.8514851     0.1980198     0.9702970     0.9306931 
acf.2.reports acf.3.reports acf.4.reports acf.5.reports        median 
    0.7128713     0.4752475     0.1980198     0.5148515     0.8712871 

$synth.loglik
[1] -1.540292

$est
[1] "I.0" "R.0"

$weights
[1] 1

$value
[1] 1.540292

$eval
[1] 81 NA

$convergence
[1] 0

> 
> comp.table <- cbind(true=exp(coef(po,ics)),guess=exp(guess[ics]),fit=exp(coef(pm.fit,ics)))
> comp.table <- apply(comp.table,2,function(x)x/sum(x))
> comp.table <- rbind(
+                     comp.table,
+                     synth.loglik=c(
+                       summary(pm.true)$synth.loglik,
+                       summary(pm.guess)$synth.loglik,
+                       summary(pm.fit)$synth.loglik
+                       )
+                     )
> comp.table
                    true         guess          fit
S.0           0.02166667   0.026342137  0.021651353
I.0           0.00100000   0.000814969  0.001015489
R.0           0.97733333   0.972842894  0.977333157
synth.loglik -3.32718185 -63.047679163 -1.540292335
> 
> x <- sapply(
+             list(true=pm.true,guess=pm.guess,fit=pm.fit),
+             function (x) trajectory(x,times=time(x),t0=timezero(x))["cases",1,]
+             )
> 
> plot(range(time(po)),range(c(states(po,"cases"),x)),bty='l',xlab="time",ylab="cases",type='n')
> points(time(po),states(po,"cases"))
> matlines(time(po),x,lty=1,col=c("red","blue","green"))
> legend("topright",lty=c(NA,1,1,1),pch=c(1,NA,NA,NA),bty='n',col=c("black","red","blue","green"),legend=c("actual",colnames(x)))
> 
> summary(tm.true <- traj.match(po,eval.only=TRUE))
$params
     gamma         mu       iota     nbasis     degree     period      beta1 
 3.2580965 -3.9120230 -4.6051702  3.0000000  3.0000000  1.0000000  7.0900768 
     beta2      beta3    beta.sd        pop        rho        S.0        I.0 
 7.4955419  6.3969297 -6.9077553 14.5574479 -0.5108256 -3.8319803 -6.9077553 
       R.0 
-0.0229275 

$loglik
[1] -49.09745

$eval
[1] 1 0

$convergence
[1] NA

$msg
[1] "no optimization performed"

> 
> summary(tm.guess <- traj.match(po,start=guess,eval.only=TRUE))
$params
     gamma         mu       iota     nbasis     degree     period      beta1 
 3.2580965 -3.9120230 -4.6051702  3.0000000  3.0000000  1.0000000  7.0900768 
     beta2      beta3    beta.sd        pop        rho        S.0        I.0 
 7.4955419  6.3969297 -6.9077553 14.5574479 -0.5108256 -3.6319803 -7.1077553 
       R.0 
-0.0229275 

$loglik
[1] -1768.807

$eval
[1] 1 0

$convergence
[1] NA

$msg
[1] "no optimization performed"

> 
> tm.fit <- traj.match(
+                      po,
+                      start=guess,
+                      est=ics[-1],
+                      method="sannbox",
+                      maxit=300,
+                      trace=2,
+                      parscale=c(0.1,0.1)
+                      )
initial evaluation:  1768.807 
iter  1  val= 1768.807 , accept= FALSE 
iter  2  val= 1768.807 , accept= FALSE 
iter  3  val= 1768.807 , accept= FALSE 
iter  4  val= 1768.807 , accept= FALSE 
iter  5  val= 1768.807 , accept= FALSE 
iter  6  val= 1768.807 , accept= FALSE 
iter  7  val= 1768.807 , accept= FALSE 
iter  8  val= 1768.807 , accept= FALSE 
iter  9  val= 1687.885 , accept= TRUE 
iter  10  val= 1687.885 , accept= FALSE 
iter  11  val= 1548.83 , accept= TRUE 
iter  12  val= 1548.83 , accept= FALSE 
iter  13  val= 1548.83 , accept= FALSE 
iter  14  val= 1548.83 , accept= FALSE 
iter  15  val= 1548.83 , accept= FALSE 
iter  16  val= 1548.83 , accept= FALSE 
iter  17  val= 1548.83 , accept= FALSE 
iter  18  val= 1548.83 , accept= FALSE 
iter  19  val= 1548.83 , accept= FALSE 
iter  20  val= 1548.83 , accept= FALSE 
iter  21  val= 1548.83 , accept= FALSE 
iter  22  val= 1548.83 , accept= FALSE 
iter  23  val= 1548.83 , accept= FALSE 
iter  24  val= 1548.83 , accept= FALSE 
iter  25  val= 1548.83 , accept= FALSE 
iter  26  val= 1548.83 , accept= FALSE 
iter  27  val= 1389.144 , accept= TRUE 
iter  28  val= 1389.144 , accept= FALSE 
iter  29  val= 1375.29 , accept= TRUE 
iter  30  val= 976.1314 , accept= TRUE 
iter  31  val= 976.1314 , accept= FALSE 
iter  32  val= 976.1314 , accept= FALSE 
iter  33  val= 976.1314 , accept= FALSE 
iter  34  val= 976.1314 , accept= FALSE 
iter  35  val= 976.1314 , accept= FALSE 
iter  36  val= 976.1314 , accept= FALSE 
iter  37  val= 976.1314 , accept= FALSE 
iter  38  val= 976.1314 , accept= FALSE 
iter  39  val= 976.1314 , accept= FALSE 
iter  40  val= 976.1314 , accept= FALSE 
iter  41  val= 976.1314 , accept= FALSE 
iter  42  val= 976.1314 , accept= FALSE 
iter  43  val= 976.1314 , accept= FALSE 
iter  44  val= 976.1314 , accept= FALSE 
iter  45  val= 976.1314 , accept= FALSE 
iter  46  val= 976.1314 , accept= FALSE 
iter  47  val= 976.1314 , accept= FALSE 
iter  48  val= 976.1314 , accept= FALSE 
iter  49  val= 976.1314 , accept= FALSE 
iter  50  val= 976.1314 , accept= FALSE 
iter  51  val= 976.1314 , accept= FALSE 
iter  52  val= 976.1314 , accept= FALSE 
iter  53  val= 976.1314 , accept= FALSE 
iter  54  val= 976.1314 , accept= FALSE 
iter  55  val= 518.0907 , accept= TRUE 
iter  56  val= 331.9071 , accept= TRUE 
iter  57  val= 331.9071 , accept= FALSE 
iter  58  val= 263.2471 , accept= TRUE 
iter  59  val= 263.2471 , accept= FALSE 
iter  60  val= 263.2471 , accept= FALSE 
iter  61  val= 263.2471 , accept= FALSE 
iter  62  val= 263.2471 , accept= FALSE 
iter  63  val= 263.2471 , accept= FALSE 
iter  64  val= 263.2471 , accept= FALSE 
iter  65  val= 263.2471 , accept= FALSE 
iter  66  val= 263.2471 , accept= FALSE 
iter  67  val= 263.2471 , accept= FALSE 
iter  68  val= 263.2471 , accept= FALSE 
iter  69  val= 263.2471 , accept= FALSE 
iter  70  val= 263.2471 , accept= FALSE 
iter  71  val= 263.2471 , accept= FALSE 
iter  72  val= 263.2471 , accept= FALSE 
iter  73  val= 263.2471 , accept= FALSE 
iter  74  val= 263.2471 , accept= FALSE 
iter  75  val= 263.2471 , accept= FALSE 
iter  76  val= 263.2471 , accept= FALSE 
iter  77  val= 263.2471 , accept= FALSE 
iter  78  val= 263.2471 , accept= FALSE 
iter  79  val= 263.2471 , accept= FALSE 
iter  80  val= 263.2471 , accept= FALSE 
iter  81  val= 263.2471 , accept= FALSE 
iter  82  val= 263.2471 , accept= FALSE 
iter  83  val= 263.2471 , accept= FALSE 
iter  84  val= 263.2471 , accept= FALSE 
iter  85  val= 248.6137 , accept= TRUE 
iter  86  val= 248.6137 , accept= FALSE 
iter  87  val= 248.6137 , accept= FALSE 
iter  88  val= 248.6137 , accept= FALSE 
iter  89  val= 248.6137 , accept= FALSE 
iter  90  val= 248.6137 , accept= FALSE 
iter  91  val= 248.6137 , accept= FALSE 
iter  92  val= 248.6137 , accept= FALSE 
iter  93  val= 248.6137 , accept= FALSE 
iter  94  val= 248.6137 , accept= FALSE 
iter  95  val= 248.6137 , accept= FALSE 
iter  96  val= 240.8026 , accept= TRUE 
iter  97  val= 240.8026 , accept= FALSE 
iter  98  val= 240.8026 , accept= FALSE 
iter  99  val= 240.8026 , accept= FALSE 
iter  100  val= 240.8026 , accept= FALSE 
iter  101  val= 240.8026 , accept= FALSE 
iter  102  val= 240.8026 , accept= FALSE 
iter  103  val= 240.8026 , accept= FALSE 
iter  104  val= 240.8026 , accept= FALSE 
iter  105  val= 240.8026 , accept= FALSE 
iter  106  val= 240.8026 , accept= FALSE 
iter  107  val= 240.8026 , accept= FALSE 
iter  108  val= 240.8026 , accept= FALSE 
iter  109  val= 240.8026 , accept= FALSE 
iter  110  val= 240.8026 , accept= FALSE 
iter  111  val= 240.8026 , accept= FALSE 
iter  112  val= 240.8026 , accept= FALSE 
iter  113  val= 240.8026 , accept= FALSE 
iter  114  val= 240.8026 , accept= FALSE 
iter  115  val= 240.8026 , accept= FALSE 
iter  116  val= 240.8026 , accept= FALSE 
iter  117  val= 240.8026 , accept= FALSE 
iter  118  val= 240.8026 , accept= FALSE 
iter  119  val= 240.8026 , accept= FALSE 
iter  120  val= 240.8026 , accept= FALSE 
iter  121  val= 240.8026 , accept= FALSE 
iter  122  val= 240.8026 , accept= FALSE 
iter  123  val= 240.8026 , accept= FALSE 
iter  124  val= 240.8026 , accept= FALSE 
iter  125  val= 240.8026 , accept= FALSE 
iter  126  val= 240.8026 , accept= FALSE 
iter  127  val= 240.8026 , accept= FALSE 
iter  128  val= 240.8026 , accept= FALSE 
iter  129  val= 240.8026 , accept= FALSE 
iter  130  val= 240.8026 , accept= FALSE 
iter  131  val= 240.8026 , accept= FALSE 
iter  132  val= 240.8026 , accept= FALSE 
iter  133  val= 240.8026 , accept= FALSE 
iter  134  val= 240.8026 , accept= FALSE 
iter  135  val= 240.8026 , accept= FALSE 
iter  136  val= 240.8026 , accept= FALSE 
iter  137  val= 240.8026 , accept= FALSE 
iter  138  val= 240.8026 , accept= FALSE 
iter  139  val= 240.8026 , accept= FALSE 
iter  140  val= 240.8026 , accept= FALSE 
iter  141  val= 240.8026 , accept= FALSE 
iter  142  val= 240.8026 , accept= FALSE 
iter  143  val= 240.8026 , accept= FALSE 
iter  144  val= 240.8026 , accept= FALSE 
iter  145  val= 240.8026 , accept= FALSE 
iter  146  val= 240.8026 , accept= FALSE 
iter  147  val= 240.8026 , accept= FALSE 
iter  148  val= 240.8026 , accept= FALSE 
iter  149  val= 240.8026 , accept= FALSE 
iter  150  val= 240.8026 , accept= FALSE 
iter  151  val= 240.8026 , accept= FALSE 
iter  152  val= 240.8026 , accept= FALSE 
iter  153  val= 240.8026 , accept= FALSE 
iter  154  val= 240.8026 , accept= FALSE 
iter  155  val= 240.8026 , accept= FALSE 
iter  156  val= 240.8026 , accept= FALSE 
iter  157  val= 240.8026 , accept= FALSE 
iter  158  val= 238.9642 , accept= TRUE 
iter  159  val= 238.9642 , accept= FALSE 
iter  160  val= 238.9642 , accept= FALSE 
iter  161  val= 210.8122 , accept= TRUE 
iter  162  val= 210.8122 , accept= FALSE 
iter  163  val= 210.8122 , accept= FALSE 
iter  164  val= 210.8122 , accept= FALSE 
iter  165  val= 210.8122 , accept= FALSE 
iter  166  val= 210.8122 , accept= FALSE 
iter  167  val= 186.3851 , accept= TRUE 
iter  168  val= 186.3851 , accept= FALSE 
iter  169  val= 186.3851 , accept= FALSE 
iter  170  val= 160.1877 , accept= TRUE 
iter  171  val= 160.1877 , accept= FALSE 
iter  172  val= 101.6028 , accept= TRUE 
iter  173  val= 101.6028 , accept= FALSE 
iter  174  val= 101.6028 , accept= FALSE 
iter  175  val= 101.6028 , accept= FALSE 
iter  176  val= 95.73939 , accept= TRUE 
iter  177  val= 95.73939 , accept= FALSE 
iter  178  val= 95.73939 , accept= FALSE 
iter  179  val= 95.73939 , accept= FALSE 
iter  180  val= 80.67959 , accept= TRUE 
iter  181  val= 80.67959 , accept= FALSE 
iter  182  val= 80.67959 , accept= FALSE 
iter  183  val= 80.67959 , accept= FALSE 
iter  184  val= 80.67959 , accept= FALSE 
iter  185  val= 80.25168 , accept= TRUE 
iter  186  val= 78.4434 , accept= TRUE 
iter  187  val= 78.4434 , accept= FALSE 
iter  188  val= 78.4434 , accept= FALSE 
iter  189  val= 78.4434 , accept= FALSE 
iter  190  val= 78.4434 , accept= FALSE 
iter  191  val= 74.25295 , accept= TRUE 
iter  192  val= 74.25295 , accept= FALSE 
iter  193  val= 74.25295 , accept= FALSE 
iter  194  val= 74.25295 , accept= FALSE 
iter  195  val= 74.25295 , accept= FALSE 
iter  196  val= 70.92698 , accept= TRUE 
iter  197  val= 70.92698 , accept= FALSE 
iter  198  val= 64.05017 , accept= TRUE 
iter  199  val= 59.82967 , accept= TRUE 
iter  200  val= 59.82967 , accept= FALSE 
iter  201  val= 59.82967 , accept= FALSE 
iter  202  val= 59.82967 , accept= FALSE 
iter  203  val= 59.82967 , accept= FALSE 
iter  204  val= 54.67986 , accept= TRUE 
iter  205  val= 54.67986 , accept= FALSE 
iter  206  val= 54.67986 , accept= FALSE 
iter  207  val= 54.67986 , accept= FALSE 
iter  208  val= 54.67986 , accept= FALSE 
iter  209  val= 54.67986 , accept= FALSE 
iter  210  val= 54.67986 , accept= FALSE 
iter  211  val= 54.67986 , accept= FALSE 
iter  212  val= 54.67986 , accept= FALSE 
iter  213  val= 54.67986 , accept= FALSE 
iter  214  val= 54.67986 , accept= FALSE 
iter  215  val= 54.67986 , accept= FALSE 
iter  216  val= 54.67986 , accept= FALSE 
iter  217  val= 54.67986 , accept= FALSE 
iter  218  val= 54.67986 , accept= FALSE 
iter  219  val= 54.67986 , accept= FALSE 
iter  220  val= 54.67986 , accept= FALSE 
iter  221  val= 54.67986 , accept= FALSE 
iter  222  val= 54.67986 , accept= FALSE 
iter  223  val= 54.67986 , accept= FALSE 
iter  224  val= 54.67986 , accept= FALSE 
iter  225  val= 52.60942 , accept= TRUE 
iter  226  val= 50.53068 , accept= TRUE 
iter  227  val= 50.53068 , accept= FALSE 
iter  228  val= 50.53068 , accept= FALSE 
iter  229  val= 50.53068 , accept= FALSE 
iter  230  val= 50.53068 , accept= FALSE 
iter  231  val= 50.53068 , accept= FALSE 
iter  232  val= 50.53068 , accept= FALSE 
iter  233  val= 49.76395 , accept= TRUE 
iter  234  val= 49.76395 , accept= FALSE 
iter  235  val= 49.76395 , accept= FALSE 
iter  236  val= 49.76395 , accept= FALSE 
iter  237  val= 49.76395 , accept= FALSE 
iter  238  val= 49.76395 , accept= FALSE 
iter  239  val= 49.76395 , accept= FALSE 
iter  240  val= 49.76395 , accept= FALSE 
iter  241  val= 49.76395 , accept= FALSE 
iter  242  val= 49.76395 , accept= FALSE 
iter  243  val= 49.76395 , accept= FALSE 
iter  244  val= 49.76395 , accept= FALSE 
iter  245  val= 49.76395 , accept= FALSE 
iter  246  val= 49.76395 , accept= FALSE 
iter  247  val= 49.76395 , accept= FALSE 
iter  248  val= 49.76395 , accept= FALSE 
iter  249  val= 49.43399 , accept= TRUE 
iter  250  val= 49.43399 , accept= FALSE 
iter  251  val= 49.43399 , accept= FALSE 
iter  252  val= 49.43399 , accept= FALSE 
iter  253  val= 49.43399 , accept= FALSE 
iter  254  val= 49.0464 , accept= TRUE 
iter  255  val= 49.0464 , accept= FALSE 
iter  256  val= 49.0464 , accept= FALSE 
iter  257  val= 49.0464 , accept= FALSE 
iter  258  val= 49.0464 , accept= FALSE 
iter  259  val= 49.0464 , accept= FALSE 
iter  260  val= 49.0464 , accept= FALSE 
iter  261  val= 49.0464 , accept= FALSE 
iter  262  val= 49.0464 , accept= FALSE 
iter  263  val= 49.0464 , accept= FALSE 
iter  264  val= 49.0464 , accept= FALSE 
iter  265  val= 49.0464 , accept= FALSE 
iter  266  val= 49.0464 , accept= FALSE 
iter  267  val= 49.0464 , accept= FALSE 
iter  268  val= 48.96057 , accept= TRUE 
iter  269  val= 48.96057 , accept= FALSE 
iter  270  val= 48.96057 , accept= FALSE 
iter  271  val= 48.96057 , accept= FALSE 
iter  272  val= 48.96057 , accept= FALSE 
iter  273  val= 48.96057 , accept= FALSE 
iter  274  val= 48.98728 , accept= TRUE 
iter  275  val= 48.98728 , accept= FALSE 
iter  276  val= 48.98728 , accept= FALSE 
iter  277  val= 48.98728 , accept= FALSE 
iter  278  val= 48.98728 , accept= FALSE 
iter  279  val= 48.99698 , accept= TRUE 
iter  280  val= 48.99698 , accept= FALSE 
iter  281  val= 48.99698 , accept= FALSE 
iter  282  val= 48.99698 , accept= FALSE 
iter  283  val= 48.99698 , accept= FALSE 
iter  284  val= 48.99698 , accept= FALSE 
iter  285  val= 48.99698 , accept= FALSE 
iter  286  val= 48.99698 , accept= FALSE 
iter  287  val= 48.99698 , accept= FALSE 
iter  288  val= 48.99698 , accept= FALSE 
iter  289  val= 48.99698 , accept= FALSE 
iter  290  val= 48.99698 , accept= FALSE 
iter  291  val= 48.99698 , accept= FALSE 
iter  292  val= 48.99698 , accept= FALSE 
iter  293  val= 48.99698 , accept= FALSE 
iter  294  val= 48.99698 , accept= FALSE 
iter  295  val= 48.99698 , accept= FALSE 
iter  296  val= 48.99698 , accept= FALSE 
iter  297  val= 48.99698 , accept= FALSE 
iter  298  val= 48.99698 , accept= FALSE 
iter  299  val= 48.99698 , accept= FALSE 
iter  300  val= 48.99698 , accept= FALSE 
best val= 48.96057 
> 
> tm.fit <- traj.match(
+                      tm.fit,
+                      est=ics[-1],
+                      method="Nelder-Mead",
+                      trace=3,
+                      reltol=1e-8,
+                      parscale=c(0.1,0.1)
+                      )
  Nelder-Mead direct search function minimizer
function value for initial parameters = 48.960570
  Scaled convergence tolerance is 4.89606e-07
Stepsize computed as 6.719358
BUILD              3 99999999999999996863366107917975552.000000 48.960570
SHRINK             7 99999999999999996863366107917975552.000000 48.960570
SHRINK            11 99999999999999996863366107917975552.000000 48.960570
LO-REDUCTION      13 1115.951600 48.960570
HI-REDUCTION      15 413.964986 48.960570
HI-REDUCTION      17 200.710094 48.960570
LO-REDUCTION      19 186.514804 48.960570
HI-REDUCTION      21 82.045525 48.960570
HI-REDUCTION      23 58.093154 48.960570
HI-REDUCTION      25 57.317825 48.960570
LO-REDUCTION      27 52.132494 48.960570
HI-REDUCTION      29 51.069592 48.960570
LO-REDUCTION      31 50.047600 48.960570
LO-REDUCTION      33 49.107318 48.960570
HI-REDUCTION      35 48.971202 48.903539
HI-REDUCTION      37 48.960570 48.899605
HI-REDUCTION      39 48.903539 48.899605
HI-REDUCTION      41 48.901354 48.885813
HI-REDUCTION      43 48.899605 48.885813
LO-REDUCTION      45 48.891635 48.885813
HI-REDUCTION      47 48.889409 48.885813
LO-REDUCTION      49 48.887505 48.884922
LO-REDUCTION      51 48.886216 48.884922
SHRINK            55 48.884993 48.884922
LO-REDUCTION      57 48.884977 48.884922
SHRINK            61 48.885120 48.884920
LO-REDUCTION      63 48.884922 48.884920
SHRINK            67 48.884922 48.884920
Exiting from Nelder Mead minimizer
    69 function evaluations used
> 
> summary(tm.fit)
$params
     gamma         mu       iota     nbasis     degree     period      beta1 
 3.2580965 -3.9120230 -4.6051702  3.0000000  3.0000000  1.0000000  7.0900768 
     beta2      beta3    beta.sd        pop        rho        S.0        I.0 
 7.4955419  6.3969297 -6.9077553 14.5574479 -0.5108256 -3.6319803 -6.7145549 
       R.0 
 0.1769881 

$loglik
[1] -48.88492

$eval
[1] 69 NA

$convergence
[1] 0

> 
> comp.table <- cbind(true=exp(coef(po,ics)),guess=exp(guess[ics]),fit=exp(coef(tm.fit,ics)))
> comp.table <- apply(comp.table,2,function(x)x/sum(x))
> comp.table <- rbind(
+                     comp.table,
+                     loglik=sapply(list(tm.true,tm.guess,tm.fit),logLik)
+                     )
> comp.table
               true         guess           fit
S.0      0.02166667  2.634214e-02  2.166860e-02
I.0      0.00100000  8.149690e-04  9.933121e-04
R.0      0.97733333  9.728429e-01  9.773381e-01
loglik -49.09744953 -1.768807e+03 -4.888492e+01
> 
> x <- sapply(
+             list(true=tm.true,guess=tm.guess,fit=tm.fit),
+             function (x) trajectory(x,times=time(x),t0=timezero(x))["cases",1,]
+             )
> 
> plot(range(time(po)),range(c(states(po,"cases"),x)),bty='l',xlab="time",ylab="cases",type='n')
> points(time(po),states(po,"cases"))
> matlines(time(po),x,lty=1,col=c("red","blue","green"))
> legend("topright",lty=c(NA,1,1,1),pch=c(1,NA,NA,NA),bty='n',col=c("black","red","blue","green"),legend=c("actual",colnames(x)))
> 
> ### now try an initial condition fitting approach based on particle filtering
> est <- ics[-1]
> np <- 10000                              # number of particles to use
> pp <- array(coef(po),dim=c(length(coef(po)),np),dimnames=list(names(coef(po)),NULL))
> ## generate an array of guesses
> guesses <- sobol.design(lower=guess[est]-0.5,upper=guess[est]+0.5,nseq=np)
> nd <- length(time(po))
> 
> ## fit the initial conditions using repeated filtering on the initial window of the data
> 
> for (j in seq_len(3)) {
+   for (k in est) {
+     pp[k,] <- guesses[[k]]
+   }
+   for (k in seq_len(5)) {
+     pf <- pfilter(po,params=pp,save.params=TRUE)
+     pp <- pf@saved.params[[nd]]
+   }
+   guesses <- sobol.design(
+                           lower=apply(pp[est,],1,min),
+                           upper=apply(pp[est,],1,max),
+                           nseq=np
+                           )
+ }
> 
> pf.fit <- po
> coef(pf.fit,ics) <- log(apply(apply(exp(pp[ics,]),2,function(x)x/sum(x)),1,mean))
Warning message:
in 'coef<-': names of 'value' are being discarded 
> pf.true <- pfilter(po,Np=2000)
> pf.guess <- pfilter(po,params=guess,Np=2000,max.fail=100)
> pf.fit <- pfilter(pf.fit,Np=2000)
> 
> comp.table <- cbind(true=exp(coef(po,ics)),guess=exp(guess[ics]),fit=exp(coef(pf.fit,ics)))
> comp.table <- apply(comp.table,2,function(x)x/sum(x))
> comp.table <- rbind(
+                     comp.table,
+                     loglik=sapply(list(pf.true,pf.guess,pf.fit),logLik)
+                     )
> comp.table
               true         guess           fit
S.0      0.02166667  2.634214e-02   0.021630290
I.0      0.00100000  8.149690e-04   0.001008232
R.0      0.97733333  9.728429e-01   0.977361478
loglik -47.53531163 -2.258025e+02 -47.316895486
> 
> x <- sapply(
+             list(true=pf.true,guess=pf.guess,fit=pf.fit),
+             function (x) trajectory(x,times=time(x),t0=timezero(x))["cases",1,]
+             )
> 
> plot(range(time(po)),range(c(states(po,"cases"),x)),bty='l',xlab="time",ylab="cases",type='n')
> points(time(po),states(po,"cases"))
> matlines(time(po),x,lty=1,col=c("red","blue","green"))
> legend("topright",lty=c(NA,1,1,1),pch=c(1,NA,NA,NA),bty='n',col=c("black","red","blue","green"),legend=c("actual",colnames(x)))
> 
> dev.off()
null device 
          1 
> 
> 
